<!DOCTYPE html>
<!--
    G√©n√©rateur d'Infographie Cybers√©curit√© v4.0 - Refactored Edition
    Copyright (C) 2025 [Guillemin Pierre-Eric]
    Licence : AGPL-3.0 (usage public/collectivit√©s) - Commerciale (entreprises)
    
    Architecture :
    - Modules JS purs (ColorManager, PickrManager, ExportManager)
    - Alpine.js pour la r√©activit√© UI
    - Structure de donn√©es v4.0
    - Documentation JSDoc compl√®te
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="G√©n√©rateur Cyberattaque v4.0">
    <title>G√©n√©rateur d'Infographie v4.0 - Refactor√©</title>
    
    <!-- Color Picker - Pickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css"/>
    
    <!-- Notifications - Suppression de Notyf -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"> -->
    
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #003d82;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light) 0%, #e9ecef 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: #2c3e50;
        }

        .app-container { display: flex; height: 100vh; overflow: hidden; }
        
        .editor-panel {
            width: 500px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1000;
        }

        .editor-header {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .toolbar {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .editor-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
        }
        
        .preview-panel { 
            flex: 1; 
            overflow-y: auto; 
            background: var(--light); 
            padding: 20px; 
            height: 100vh; 
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #1e7e34); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #c82333); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #e0a800); color: #212529; }
        .btn-info { background: linear-gradient(135deg, var(--info), #138496); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }
        
        .form-group textarea { resize: vertical; min-height: 80px; }

        .section-header {
            background: linear-gradient(135deg, var(--light), #e9ecef);
            padding: 15px;
            margin: 30px -20px 20px -20px;
            border-left: 4px solid var(--primary);
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .color-input-group {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .color-picker-btn {
            width: 100%;
            height: 60px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .color-picker-btn::before {
            content: 'üé®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .color-picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }

        .color-picker-btn:hover::before { opacity: 0.3; }

        .color-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            color: #495057;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .step-editor {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8f9fa, white);
            transition: var(--transition);
            cursor: move;
        }

        .step-editor:hover {
            border-color: var(--primary);
            box-shadow: var(--box-shadow);
        }

        .step-editor.sortable-ghost {
            opacity: 0.5;
            background: #e3f2fd;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .step-number-input {
            width: 60px !important;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .step-icon-input {
            width: 80px !important;
            text-align: center;
            font-size: 20px;
            cursor: pointer;
        }

        .action-item-editor {
            border: 2px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            transition: var(--transition);
        }

        .action-color-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .action-color-mini-picker {
            text-align: center;
        }

        .action-color-mini-picker label {
            display: block;
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .action-color-mini-btn {
            width: 100%;
            height: 35px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .action-color-mini-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }

        .drag-handle {
            cursor: grab;
            padding: 8px;
            color: #6c757d;
            font-size: 20px;
        }

        .drag-handle:active { cursor: grabbing; }

        /* PREVIEW STYLES */
        .preview-container {
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .preview-header {
            color: white;
            text-align: center;
            padding: 50px 30px;
            position: relative;
        }
        
        .preview-header::before {
            content: '‚ö†Ô∏è';
            font-size: 80px;
            display: block;
            margin-bottom: 25px;
            animation: pulse 2s infinite;
        }
        
        .preview-header.hide-icon::before {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .preview-header h1 {
            font-size: 3em;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            letter-spacing: 2px;
        }
        
        .preview-header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 500;
        }

        .preview-header .logo,
        .preview-footer .logo {
            position: absolute;
            max-height: 100px;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .preview-header .logo.top-left { left: 25px; top: 25px; }
        .preview-header .logo.top-right { right: 25px; top: 25px; }
        .preview-header .logo.top-center { left: 50%; top: 25px; transform: translateX(-50%); }

        .preview-footer .logo.bottom-left { left: 25px; bottom: 25px; }
        .preview-footer .logo.bottom-right { right: 25px; bottom: 25px; }
        .preview-footer .logo.bottom-center { left: 50%; bottom: 25px; transform: translateX(-50%); }
        
        .preview-timeline {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
            padding: 0 20px;
        }
        
        .preview-timeline-item {
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            margin: 8px;
            font-weight: 700;
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: var(--transition);
        }
        
        .preview-steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 35px;
            padding: 50px;
        }
        
        .preview-step {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-left: 8px solid;
            position: relative;
            transition: var(--transition);
        }
        
        .preview-step:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 45px rgba(0,0,0,0.15);
        }
        
        .preview-step-number {
            position: absolute;
            top: -20px;
            left: 25px;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.4em;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .preview-step-icon {
            font-size: 4em;
            margin-bottom: 25px;
            display: block;
        }
        
        .preview-step h3 {
            font-size: 1.6em;
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 800;
            line-height: 1.2;
        }
        
        .preview-action-item {
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .preview-action-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .preview-emergency-contact {
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 50px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .preview-footer {
            color: white;
            text-align: center;
            padding: 40px 30px;
            position: relative;
            line-height: 1.6;
        }

        .logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .logo-item {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .emoji-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 40000;
            display: none;
        }

        .emoji-selector-overlay.active { display: block; }

        .emoji-selector {
            position: fixed;
            z-index: 50000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            display: none;
            overflow-y: auto;
        }

        .emoji-selector.active { display: block; }

        .emoji-selector h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .emoji-option {
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 24px;
            transition: all 0.2s ease;
            background: #f8f9fa;
            user-select: none;
        }

        .emoji-option:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* TEXT FORMATTING TOOLBAR */
        .text-toolbar {
            position: absolute;
            bottom: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .text-toolbar.active {
            display: flex;
        }
        
        .text-toolbar-btn {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .text-toolbar-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }
        
        .text-toolbar-separator {
            width: 1px;
            background: #dee2e6;
            margin: 0 5px;
        }
        
        .textarea-wrapper {
            position: relative;
        }

        /* NOTIFICATIONS CUSTOM */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            font-weight: 600;
            z-index: 60000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.2s;
            opacity: 1;
        }
        
        .custom-notification.success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        .custom-notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .custom-notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .custom-notification-message {
            flex: 1;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .notyf { z-index: 60000 !important; }

        @media (max-width: 1400px) {
            .app-container { flex-direction: column; }
            .editor-panel { width: 100%; max-height: 500px; }
            .preview-steps-grid { grid-template-columns: 1fr; padding: 30px; }
        }

        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .w-100 { width: 100%; }
    </style>
</head>
<body>

    <div 
        x-data="infographicApp()" 
        x-init="init()"
        class="app-container"
    >
        
        <!-- EDITOR PANEL -->
        <div class="editor-panel">
            
            <div class="editor-header">
                <h2>‚úèÔ∏è G√©n√©rateur d'Infographie v4.0</h2>
                <p>Refactor√© ‚Ä¢ Optimis√© ‚Ä¢ Document√©</p>
            </div>

            <div class="toolbar">
                <button class="btn btn-primary btn-sm" @click="saveProject()">üíæ Sauvegarder</button>
                <button class="btn btn-info btn-sm" @click="$refs.loadFile.click()">üìÇ Charger</button>
                <button class="btn btn-success btn-sm" @click="showExportModal = true">üì• Export</button>
                <button class="btn btn-danger btn-sm" @click="resetProject()">üîÑ Reset</button>
                
                <input 
                    type="file" 
                    accept=".json,.html" 
                    x-ref="loadFile" 
                    @change="handleLoadFile($event)"
                    style="display: none;"
                >
            </div>
            
            <div class="editor-content">
                
                <!-- M√âTADONN√âES -->
                <div class="section-header">üìã M√©tadonn√©es du projet</div>
                
                <div class="form-group">
                    <label>Nom du projet</label>
                    <input type="text" x-model="project.metadata.name">
                </div>
                
                <div class="form-group">
                    <label>Auteur</label>
                    <input type="text" x-model="project.metadata.author">
                </div>
                
                <div class="form-group">
                    <label>Organisation</label>
                    <input type="text" x-model="project.metadata.organization">
                </div>
                
                <!-- CONTENU -->
                <div class="section-header">üìù Contenu principal</div>
                
                <div class="form-group">
                    <label>Titre principal</label>
                    <input type="text" x-model="project.content.title">
                </div>
                
                <div class="form-group">
                    <label>Sous-titre</label>
                    <input type="text" x-model="project.content.subtitle">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" x-model="project.content.showHeaderIcon" style="width: auto; cursor: pointer;">
                        <span>Afficher l'ic√¥ne ‚ö†Ô∏è dans l'en-t√™te</span>
                    </label>
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                        üí° D√©sactivez si vous avez un logo en haut-centre ou pr√©f√©rez une en-t√™te √©pur√©e
                    </p>
                </div>
                
                <div class="form-group">
                    <label>Message d'urgence</label>
                    <textarea x-model="project.content.emergencyMessage"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Message de pied de page</label>
                    <textarea x-model="project.content.footerMessage"></textarea>
                </div>

                <!-- COULEURS GLOBALES -->
                <div class="section-header">üé® Couleurs principales</div>
                
                <div class="color-grid">
                    <template x-for="(label, key) in colorLabels" :key="key">
                        <div class="color-input-group">
                            <div 
                                class="color-picker-btn" 
                                :style="`background-color: ${project.theme.colors[key]}`"
                                @click="openGlobalColorPicker(key)"
                            ></div>
                            <label class="color-label" x-text="label"></label>
                        </div>
                    </template>
                </div>

                <!-- LOGOS -->
                <div class="section-header">üñºÔ∏è Logos</div>
                
                <template x-for="(logo, logoIndex) in project.elements.logos" :key="logo.id">
                    <div class="logo-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <strong x-text="`Logo ${logoIndex + 1}`"></strong>
                            <button class="btn btn-danger btn-sm" @click="removeLogo(logoIndex)">üóëÔ∏è Supprimer</button>
                        </div>
                        
                        <div class="form-group">
                            <label>URL du logo</label>
                            <input type="url" x-model="logo.url" @change="updateLogoFromUrl(logoIndex)">
                        </div>
                        
                        <div class="form-group">
                            <label>Ou t√©l√©charger un fichier</label>
                            <input type="file" accept="image/*" @change="handleLogoFile($event, logoIndex)">
                        </div>
                        
                        <template x-if="logo.file || logo.url">
                            <div>
                                <img 
                                    :src="logo.file || logo.url" 
                                    class="logo-preview"
                                    alt="Logo preview"
                                >
                                
                                <div class="form-group">
                                    <label>Position</label>
                                    <select x-model="logo.position">
                                        <option value="top-left">Haut gauche</option>
                                        <option value="top-center">Haut centre</option>
                                        <option value="top-right">Haut droite</option>
                                        <option value="bottom-left">Bas gauche</option>
                                        <option value="bottom-center">Bas centre</option>
                                        <option value="bottom-right">Bas droite</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Taille: <span x-text="logo.size + 'px'"></span></label>
                                    <input type="range" x-model.number="logo.size" min="50" max="300" class="w-100">
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                
                <button class="btn btn-success w-100 mt-20" @click="addLogo()">
                    ‚ûï Ajouter un logo
                </button>

                <!-- TIMELINE -->
                <div class="section-header">‚è±Ô∏è Timeline</div>
                
                <div x-ref="timelineContainer">
                    <template x-for="(item, index) in project.elements.timeline" :key="item.id">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select x-model="item.type" style="width: 120px;">
                                <option value="item">üìå √âl√©ment</option>
                                <option value="separator">‚û°Ô∏è S√©parateur</option>
                            </select>
                            <input 
                                type="text" 
                                x-model="item.text" 
                                style="flex: 1;"
                                @click="if(item.type === 'separator') openEmojiSelector('timeline', index)"
                                :readonly="item.type === 'separator'"
                            >
                            <button class="btn btn-danger btn-sm" @click="project.elements.timeline.splice(index, 1)">üóëÔ∏è</button>
                        </div>
                    </template>
                </div>
                
                <button class="btn btn-success w-100 mt-20" @click="addTimelineItem()">
                    ‚ûï Ajouter √©l√©ment timeline
                </button>

                <!-- √âTAPES -->
                <div class="section-header">üìã √âtapes et actions</div>
                
                <div x-ref="stepsContainer">
                    <template x-for="(step, stepIndex) in project.elements.steps" :key="step.id">
                        <div class="step-editor">
                            <div class="step-header">
                                <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                <input type="number" class="step-number-input" x-model.number="step.number" min="1" max="99">
                                <input 
                                    type="text" 
                                    class="step-icon-input" 
                                    x-model="step.icon" 
                                    @click="openEmojiSelector('step', stepIndex)"
                                    readonly
                                    style="cursor: pointer;"
                                >
                                <input type="text" style="flex: 1;" x-model="step.title">
                            </div>
                            
                            <div class="form-group">
                                <label>Cat√©gorie d'√©tape</label>
                                <select x-model="step.category">
                                    <option value="immediate">üö® Imm√©diat (Rouge)</option>
                                    <option value="management">üë• Gestion (Bleu)</option>
                                    <option value="communication">üì¢ Communication (Orange)</option>
                                    <option value="continuity">‚úÖ Continuit√© (Vert)</option>
                                </select>
                            </div>
                            
                            <!-- Personnalisation couleurs √©tape -->
                            <div class="form-group">
                                <label>üé® Personnalisation des couleurs (optionnel)</label>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
                                    <div>
                                        <label style="font-size: 11px; color: #6c757d; margin-bottom: 5px; display: block;">Bordure gauche</label>
                                        <div 
                                            class="color-picker-btn" 
                                            style="width: 100%; height: 40px;"
                                            :style="`background-color: ${getStepColor(step, 'border')}`"
                                            @click="openStepColorPicker(stepIndex, 'border')"
                                        ></div>
                                    </div>
                                    
                                    <div>
                                        <label style="font-size: 11px; color: #6c757d; margin-bottom: 5px; display: block;">Fond de la carte</label>
                                        <div 
                                            class="color-picker-btn" 
                                            style="width: 100%; height: 40px;"
                                            :style="`background-color: ${getStepColor(step, 'background')}`"
                                            @click="openStepColorPicker(stepIndex, 'background')"
                                        ></div>
                                    </div>
                                    
                                    <div>
                                        <label style="font-size: 11px; color: #6c757d; margin-bottom: 5px; display: block;">Couleur du texte</label>
                                        <div 
                                            class="color-picker-btn" 
                                            style="width: 100%; height: 40px;"
                                            :style="`background-color: ${getStepColor(step, 'text')}`"
                                            @click="openStepColorPicker(stepIndex, 'text')"
                                        ></div>
                                    </div>
                                </div>
                                
                                <button 
                                    class="btn btn-sm btn-danger w-100" 
                                    style="margin-top: 10px;"
                                    @click="resetStepColors(stepIndex)"
                                    x-show="hasCustomStepColors(step)"
                                >
                                    üîÑ R√©initialiser couleurs √©tape
                                </button>
                            </div>
                            
                            <!-- Actions -->
                            <div class="form-group">
                                <label>Actions de cette √©tape</label>
                                <template x-for="(action, actionIndex) in step.actions" :key="action.id">
                                    <div class="action-item-editor">
                                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                            <select x-model="action.type" style="min-width: 120px;">
                                                <option value="critical">üî¥ Critique</option>
                                                <option value="important">üü† Important</option>
                                                <option value="info">üîµ Info</option>
                                                <option value="success">üü¢ Succ√®s</option>
                                            </select>
                                            <button 
                                                class="btn btn-sm" 
                                                :class="action.customColors ? 'btn-warning' : 'btn-info'"
                                                @click="toggleActionCustomColors(stepIndex, actionIndex)"
                                                style="white-space: nowrap;"
                                                x-text="action.customColors ? '‚úèÔ∏è Perso' : 'üé® Custom'"
                                            ></button>
                                            <button class="btn btn-danger btn-sm" @click="step.actions.splice(actionIndex, 1)">üóëÔ∏è</button>
                                        </div>
                                        
                                        <div x-show="!!action.customColors" class="action-color-controls" style="display: none;">
                                            <div class="action-color-mini-picker">
                                                <label>Bordure</label>
                                                <div 
                                                    class="action-color-mini-btn"
                                                    :style="`background-color: ${getActionColor(action, step, 'border')}`"
                                                    @click="openActionColorPicker(stepIndex, actionIndex, 'border')"
                                                ></div>
                                            </div>
                                            <div class="action-color-mini-picker">
                                                <label>Fond</label>
                                                <div 
                                                    class="action-color-mini-btn"
                                                    :style="`background-color: ${getActionColor(action, step, 'background')}`"
                                                    @click="openActionColorPicker(stepIndex, actionIndex, 'background')"
                                                ></div>
                                            </div>
                                            <div class="action-color-mini-picker">
                                                <label>Texte</label>
                                                <div 
                                                    class="action-color-mini-btn"
                                                    :style="`background-color: ${getActionColor(action, step, 'text')}`"
                                                    @click="openActionColorPicker(stepIndex, actionIndex, 'text')"
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        <div class="textarea-wrapper">
                                            <div class="text-toolbar" :id="`toolbar-${stepIndex}-${actionIndex}`">
                                                <button class="text-toolbar-btn" @click="insertTag($event, stepIndex, actionIndex, '<strong>', '</strong>')" title="Gras">
                                                    <strong>B</strong>
                                                </button>
                                                <button class="text-toolbar-btn" @click="insertTag($event, stepIndex, actionIndex, '<em>', '</em>')" title="Italique">
                                                    <em>I</em>
                                                </button>
                                                <button class="text-toolbar-btn" @click="insertTag($event, stepIndex, actionIndex, '<del>', '</del>')" title="Barr√©">
                                                    <del>S</del>
                                                </button>
                                                <div class="text-toolbar-separator"></div>
                                                <button class="text-toolbar-btn" @click="insertHighlight($event, stepIndex, actionIndex)" title="Surligner">
                                                    üé®
                                                </button>
                                                <button class="text-toolbar-btn" @click="openEmojiForAction(stepIndex, actionIndex)" title="Ins√©rer emoji">
                                                    üòä
                                                </button>
                                                <div class="text-toolbar-separator"></div>
                                                <button class="text-toolbar-btn" @click="insertTag($event, stepIndex, actionIndex, '<br>', '')" title="Saut de ligne">
                                                    ‚Üµ
                                                </button>
                                                <button class="text-toolbar-btn" @click="insertTag($event, stepIndex, actionIndex, '‚Ä¢ ', '')" title="Puce">
                                                    ‚Ä¢
                                                </button>
                                            </div>
                                            <textarea 
                                                x-model="action.text" 
                                                style="min-height: 60px;"
                                                @focus="showToolbar($event, stepIndex, actionIndex)"
                                                @blur="hideToolbar($event, stepIndex, actionIndex)"
                                                :id="`action-textarea-${stepIndex}-${actionIndex}`"
                                            ></textarea>
                                        </div>
                                    </div>
                                </template>
                                <button class="btn btn-primary w-100 mt-20" @click="addAction(stepIndex)">
                                    ‚ûï Ajouter action
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" @click="duplicateStep(stepIndex)">üìã Dupliquer</button>
                                <button class="btn btn-danger" @click="removeStep(stepIndex)">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    </template>
                </div>
                
                <button class="btn btn-success w-100 mt-20" @click="addStep()">
                    ‚ûï Ajouter une √©tape
                </button>

            </div>
        </div>
        
        <!-- PREVIEW PANEL -->
        <div class="preview-panel" :style="`background: ${project.theme.colors.background}`">
            <div class="text-center mb-20">
                <h3 style="color: var(--primary);">üëÅÔ∏è Aper√ßu en temps r√©el</h3>
            </div>
            
            <div id="preview-container" class="preview-container" :style="`background: ${project.theme.colors.contentBg}`">
                
                <!-- Header -->
                <div class="preview-header" :class="{ 'hide-icon': !project.content.showHeaderIcon }" :style="`background: linear-gradient(135deg, ${project.theme.colors.header}, ${adjustBrightness(project.theme.colors.header, -20)})`">
                    <template x-for="logo in project.elements.logos.filter(l => l.position && l.position.startsWith('top'))" :key="logo.id">
                        <img 
                            :src="logo.file || logo.url"
                            :class="`logo ${logo.position}`"
                            :style="`max-width: ${logo.size}px`"
                            alt="Logo"
                        >
                    </template>
                    <h1 x-text="project.content.title"></h1>
                    <p x-text="project.content.subtitle"></p>
                </div>
                
                <!-- Timeline -->
                <div class="preview-timeline">
                    <template x-for="item in project.elements.timeline" :key="item.id">
                        <div 
                            class="preview-timeline-item"
                            :style="item.type === 'item' ? 
                                `background: linear-gradient(135deg, ${project.theme.colors.timeline}, ${adjustBrightness(project.theme.colors.timeline, -15)})` : 
                                `background: transparent; color: ${project.theme.colors.timeline}; font-size: 1.2em;`"
                            x-text="item.text"
                        ></div>
                    </template>
                </div>
                
                <!-- Steps Grid -->
                <div class="preview-steps-grid" :style="`background: ${project.theme.colors.contentBg}`">
                    <template x-for="step in project.elements.steps" :key="step.id">
                        <div 
                            class="preview-step"
                            :style="`
                                border-left-color: ${getStepColor(step, 'border')}; 
                                background: ${getStepColor(step, 'background')};
                                color: ${getStepColor(step, 'text')};
                            `"
                        >
                            <div 
                                class="preview-step-number"
                                :style="`background: linear-gradient(135deg, ${project.theme.colors.stepNumber}, ${adjustBrightness(project.theme.colors.stepNumber, -20)})`"
                                x-text="step.number"
                            ></div>
                            <div class="preview-step-icon" x-text="step.icon"></div>
                            
                            <h3 x-text="step.title" :style="`color: ${getStepColor(step, 'text')};`"></h3>
                            
                            <div>
                                <template x-for="action in step.actions" :key="action.id">
                                    <div 
                                        class="preview-action-item"
                                        :style="`
                                            border-left-color: ${getActionColor(action, step, 'border')}; 
                                            background: ${getActionColor(action, step, 'background')};
                                            color: ${getActionColor(action, step, 'text')};
                                        `"
                                        x-html="formatText(action.text)"
                                    ></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Emergency Contact -->
                <div 
                    class="preview-emergency-contact"
                    :style="`background: linear-gradient(135deg, ${project.theme.colors.emergency}, ${adjustBrightness(project.theme.colors.emergency, -20)})`"
                    x-text="project.content.emergencyMessage"
                ></div>
                
                <!-- Footer -->
                <div 
                    class="preview-footer"
                    :style="`background: linear-gradient(135deg, ${project.theme.colors.footer}, ${adjustBrightness(project.theme.colors.footer, -15)})`"
                >
                    <template x-for="logo in project.elements.logos.filter(l => l.position && l.position.startsWith('bottom'))" :key="logo.id">
                        <img 
                            :src="logo.file || logo.url"
                            :class="`logo ${logo.position}`"
                            :style="`max-width: ${logo.size}px`"
                            alt="Logo"
                        >
                    </template>
                    <template x-for="line in project.content.footerMessage.split('\n')" :key="line">
                        <p x-text="line"></p>
                    </template>
                </div>
                
            </div>
        </div>

        <!-- MODAL EXPORT -->
        <div 
            x-show="showExportModal" 
            @click.self="showExportModal = false"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 30000;"
            x-transition
        >
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 650px; width: 90%;">
                <h3 style="margin-bottom: 20px; text-align: center;">üì• Export & Impression</h3>
                
                <div style="display: grid; gap: 20px;">
                    <div style="border: 2px solid var(--success); border-radius: 10px; padding: 20px;">
                        <h4 style="color: var(--success); margin-bottom: 15px;">üåê Format HTML</h4>
                        <button class="btn btn-success w-100" @click="exportHTML()">üåê Exporter en HTML</button>
                    </div>
                    
                    <div style="border: 2px solid var(--primary); border-radius: 10px; padding: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">üìÑ Format PDF (Poster)</h4>
                        
                        <!-- Warning si trop d'√©tapes -->
                        <div x-show="project.elements.steps.length > 10" style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                            ‚ö†Ô∏è <strong>Attention :</strong> Votre infographie contient <span x-text="project.elements.steps.length"></span> √©tapes. Pour un rendu optimal sur poster, nous recommandons maximum 10 √©tapes.
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Format de page :</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; cursor: pointer; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.2s;" :style="pdfFormat === 'A3' ? 'border-color: var(--primary); background: #e3f2fd;' : ''">
                                    <input type="radio" x-model="pdfFormat" value="A3" style="margin-right: 5px;">
                                    A3 (297√ó420mm)
                                </label>
                                <label style="flex: 1; cursor: pointer; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.2s;" :style="pdfFormat === 'A2' ? 'border-color: var(--primary); background: #e3f2fd;' : ''">
                                    <input type="radio" x-model="pdfFormat" value="A2" style="margin-right: 5px;">
                                    A2 (420√ó594mm)
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Orientation :</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; cursor: pointer; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.2s;" :style="pdfOrientation === 'portrait' ? 'border-color: var(--primary); background: #e3f2fd;' : ''">
                                    <input type="radio" x-model="pdfOrientation" value="portrait" style="margin-right: 5px;">
                                    üìÑ Portrait
                                </label>
                                <label style="flex: 1; cursor: pointer; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.2s;" :style="pdfOrientation === 'landscape' ? 'border-color: var(--primary); background: #e3f2fd;' : ''">
                                    <input type="radio" x-model="pdfOrientation" value="landscape" style="margin-right: 5px;">
                                    üìÉ Paysage
                                </label>
                            </div>
                        </div>
                        
                        <p style="font-size: 12px; color: #6c757d; margin-bottom: 15px; text-align: center;">
                            ‚ÑπÔ∏è Le contenu sera ajust√© sur 1 page ‚Ä¢ Qualit√© 300 DPI
                        </p>
                        
                        <button class="btn btn-primary w-100" @click="exportPDF()">üìÑ G√©n√©rer PDF</button>
                    </div>
                    
                    <div style="border: 2px solid var(--info); border-radius: 10px; padding: 20px;">
                        <h4 style="color: var(--info); margin-bottom: 15px;">üñºÔ∏è Format Image</h4>
                        <button class="btn btn-info w-100" @click="exportPNG()">üñºÔ∏è Exporter en PNG (300 DPI)</button>
                    </div>
                </div>
                
                <button class="btn btn-danger mt-20 w-100" @click="showExportModal = false">Fermer</button>
            </div>
        </div>

        <!-- EMOJI SELECTOR -->
        <div class="emoji-selector-overlay" @click="closeEmojiSelector()" :class="{ 'active': showEmojiSelector }"></div>
        <div class="emoji-selector" :class="{ 'active': showEmojiSelector }">
            <h3>Choisir un emoji</h3>
            <div class="emoji-grid">
                <template x-for="emoji in availableEmojis" :key="emoji">
                    <div class="emoji-option" @click="selectEmoji(emoji)" x-text="emoji"></div>
                </template>
            </div>
            <button class="btn btn-danger w-100 mt-20" @click="closeEmojiSelector()">Fermer</button>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ============================================
        // MODULE 5: CUSTOM NOTIFICATION SYSTEM
        // ============================================
        
        /**
         * Syst√®me de notification custom sans d√©pendances
         * R√©sout les bugs de Notyf en environnement local
         * @namespace NotificationManager
         */
        const NotificationManager = {
            currentNotification: null,
            
            /**
             * Affiche une notification
             * @param {string} message - Message √† afficher
             * @param {string} type - Type : 'success' ou 'error'
             * @param {number} duration - Dur√©e en ms (d√©faut: 2500)
             */
            show(message, type = 'success', duration = 2500) {
                // Supprimer la notification existante
                this.clear();
                
                // Cr√©er la nouvelle notification
                const notif = document.createElement('div');
                notif.className = `custom-notification ${type}`;
                
                const icon = document.createElement('div');
                icon.className = 'custom-notification-icon';
                icon.textContent = type === 'success' ? '‚úì' : '‚úï';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'custom-notification-message';
                messageDiv.textContent = message;
                
                notif.appendChild(icon);
                notif.appendChild(messageDiv);
                
                document.body.appendChild(notif);
                this.currentNotification = notif;
                
                // Auto-suppression apr√®s la dur√©e + animation
                setTimeout(() => {
                    if (this.currentNotification === notif) {
                        this.clear();
                    }
                }, duration);
            },
            
            /**
             * Supprime la notification actuelle
             */
            clear() {
                if (this.currentNotification) {
                    this.currentNotification.remove();
                    this.currentNotification = null;
                }
            },
            
            /**
             * Raccourci pour notification de succ√®s
             * @param {string} message - Message
             */
            success(message) {
                this.show(message, 'success');
            },
            
            /**
             * Raccourci pour notification d'erreur
             * @param {string} message - Message
             */
            error(message) {
                this.show(message, 'error');
            }
        };
        
        // ============================================
        // MODULE 1: COLOR MANAGER
        // ============================================
        
        /**
         * Gestionnaire centralis√© des couleurs
         * G√®re les presets et la r√©solution des couleurs avec fallback
         * @namespace ColorManager
         */
        const ColorManager = {
            /**
             * Presets de couleurs par cat√©gorie d'√©tape
             * @type {Object.<string, Object>}
             */
            categoryPresets: {
                immediate: { 
                    border: '#e74c3c', 
                    background: '#ffffff', 
                    text: '#2c3e50', 
                    actionBg: 'rgba(231, 76, 60, 0.05)' 
                },
                management: { 
                    border: '#0056b3', 
                    background: '#ffffff', 
                    text: '#2c3e50', 
                    actionBg: 'rgba(0, 86, 179, 0.05)' 
                },
                communication: { 
                    border: '#f39c12', 
                    background: '#ffffff', 
                    text: '#2c3e50', 
                    actionBg: 'rgba(243, 156, 18, 0.05)' 
                },
                continuity: { 
                    border: '#27ae60', 
                    background: '#ffffff', 
                    text: '#2c3e50', 
                    actionBg: 'rgba(39, 174, 96, 0.05)' 
                }
            },
            
            /**
             * Presets de couleurs par type d'action
             * @type {Object.<string, Object>}
             */
            actionTypePresets: {
                critical: { 
                    border: '#e74c3c', 
                    background: 'rgba(231, 76, 60, 0.08)', 
                    text: '#2c3e50' 
                },
                important: { 
                    border: '#f39c12', 
                    background: 'rgba(243, 156, 18, 0.08)', 
                    text: '#2c3e50' 
                },
                info: { 
                    border: '#3498db', 
                    background: 'rgba(52, 152, 219, 0.08)', 
                    text: '#2c3e50' 
                },
                success: { 
                    border: '#27ae60', 
                    background: 'rgba(39, 174, 96, 0.08)', 
                    text: '#2c3e50' 
                }
            },
            
            /**
             * Fonction unique pour obtenir la couleur d'un √©l√©ment
             * Priorit√© : customColors > preset cat√©gorie/type > fallback global
             * 
             * @param {Object} element - L'√©l√©ment (step ou action)
             * @param {string} colorType - Type de couleur ('border'|'background'|'text'|'actionBg')
             * @param {Object} context - Contexte { project, parentStep }
             * @returns {string} Couleur en format hex ou rgba
             */
            getColor(element, colorType, context = {}) {
                // Priorit√© 1: Couleur personnalis√©e de l'√©l√©ment
                if (element.customColors?.[colorType]) {
                    return element.customColors[colorType];
                }
                
                // Priorit√© 2: Si c'est une √©tape
                if (element.category) {
                    const preset = this.categoryPresets[element.category];
                    if (preset && preset[colorType]) {
                        return preset[colorType];
                    }
                }
                
                // Priorit√© 3: Si c'est une action
                if (element.type && context.parentStep) {
                    // Cas sp√©cial: pour le fond d'action, v√©rifier d'abord la step parente
                    if (colorType === 'background' && context.parentStep.customColors?.actionBg) {
                        return context.parentStep.customColors.actionBg;
                    }
                    
                    const preset = this.actionTypePresets[element.type];
                    if (preset && preset[colorType]) {
                        return preset[colorType];
                    }
                }
                
                // Fallback: couleurs globales du projet
                if (context.project?.theme?.colors?.[colorType]) {
                    return context.project.theme.colors[colorType];
                }
                
                // Fallback ultime
                const defaults = {
                    border: '#3498db',
                    background: '#ffffff',
                    text: '#2c3e50',
                    actionBg: 'rgba(52, 152, 219, 0.05)'
                };
                
                return defaults[colorType] || '#ffffff';
            },
            
            /**
             * Ajuste la luminosit√© d'une couleur hexad√©cimale
             * @param {string} hex - Couleur en format hex (#RRGGBB)
             * @param {number} amount - Montant d'ajustement (-255 √† +255)
             * @returns {string} Couleur ajust√©e en format hex
             */
            adjustBrightness(hex, amount) {
                const usePound = hex[0] === '#';
                const col = usePound ? hex.slice(1) : hex;
                const num = parseInt(col, 16);
                let r = (num >> 16) + amount;
                let g = (num >> 8 & 0x00FF) + amount;
                let b = (num & 0x0000FF) + amount;
                r = r > 255 ? 255 : r < 0 ? 0 : r;
                g = g > 255 ? 255 : g < 0 ? 0 : g;
                b = b > 255 ? 255 : b < 0 ? 0 : b;
                return (usePound ? '#' : '') + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
            },
            
            /**
             * Convertit une couleur hex en rgba
             * @param {string} hex - Couleur en format hex
             * @param {number} alpha - Canal alpha (0-1)
             * @returns {string} Couleur en format rgba
             */
            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
        };
        
        // ============================================
        // MODULE 2: PICKR MANAGER
        // ============================================
        
        /**
         * Gestionnaire centralis√© des color pickers Pickr
         * G√®re le cycle de vie et la m√©moire des instances
         * @namespace PickrManager
         */
        const PickrManager = {
            /** @type {Object.<string, Object>} */
            instances: {},
            
            /**
             * Convertit une couleur RGBA en HEX (sans alpha)
             * @param {string} color - Couleur RGBA ou HEX
             * @returns {string} Couleur en HEX
             */
            normalizeColor(color) {
                // Si c'est d√©j√† en HEX, retourner tel quel
                if (color.startsWith('#')) {
                    return color;
                }
                
                // Si c'est en RGBA, extraire les composantes et convertir en HEX
                if (color.startsWith('rgba')) {
                    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
                    if (match) {
                        const r = parseInt(match[1]);
                        const g = parseInt(match[2]);
                        const b = parseInt(match[3]);
                        return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                    }
                }
                
                // Fallback
                return color;
            },
            
            /**
             * Convertit une couleur string (HEX ou RGBA) pour Pickr
             * @param {string} color - Couleur en format string
             * @param {boolean} withOpacity - Si on veut garder l'opacit√©
             * @returns {string} Couleur en format string
             */
            colorToPickrFormat(color, withOpacity) {
                // Si c'est d√©j√† en RGBA et on veut l'opacit√©, retourner tel quel
                if (color.startsWith('rgba') && withOpacity) {
                    return color;
                }
                
                // Si c'est en RGBA mais on ne veut pas l'opacit√©, convertir en HEX
                if (color.startsWith('rgba') && !withOpacity) {
                    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                    if (match) {
                        const r = parseInt(match[1]);
                        const g = parseInt(match[2]);
                        const b = parseInt(match[3]);
                        return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                    }
                }
                
                // Si c'est en HEX et on veut l'opacit√©, convertir en RGBA avec alpha=1
                if (color.startsWith('#') && withOpacity) {
                    const hex = color.slice(1);
                    const r = parseInt(hex.slice(0, 2), 16);
                    const g = parseInt(hex.slice(2, 4), 16);
                    const b = parseInt(hex.slice(4, 6), 16);
                    return `rgba(${r}, ${g}, ${b}, 1)`;
                }
                
                // Sinon retourner tel quel
                return color;
            },
            
            /**
             * Ouvre un color picker
             * @param {string} key - Cl√© unique pour identifier l'instance
             * @param {string} currentColor - Couleur actuelle
             * @param {Function} onSave - Callback lors de la sauvegarde
             * @param {Object} options - Options additionnelles pour Pickr
             */
            open(key, currentColor, onSave, options = {}) {
                // Nettoyer l'ancienne instance si elle existe
                this.close(key);
                
                const container = document.createElement('div');
                document.body.appendChild(container);
                
                // Convertir la couleur au bon format pour Pickr
                const pickrColor = this.colorToPickrFormat(currentColor, options.allowOpacity);
                
                const pickr = Pickr.create({
                    el: container,
                    theme: 'nano',
                    default: pickrColor,
                    comparison: false,
                    swatchesOnly: false,
                    defaultRepresentation: options.allowOpacity ? 'RGBA' : 'HEXA',
                    ...options,
                    components: {
                        preview: true,
                        opacity: options.allowOpacity || false,
                        hue: true,
                        interaction: {
                            hex: !options.allowOpacity,
                            rgba: options.allowOpacity || false,
                            input: true,
                            save: true,
                            clear: false,
                            cancel: false,
                            ...options.interaction
                        }
                    }
                });
                
                pickr.on('save', color => {
                    if (color) {
                        let savedColor;
                        
                        if (options.allowOpacity) {
                            // Construire manuellement la string RGBA
                            const rgba = color.toRGBA();
                            savedColor = `rgba(${Math.round(rgba[0])}, ${Math.round(rgba[1])}, ${Math.round(rgba[2])}, ${rgba[3]})`;
                        } else {
                            savedColor = color.toHEXA().toString();
                        }
                        
                        onSave(savedColor);
                    }
                    this.close(key);
                });
                
                pickr.on('hide', () => this.close(key));
                
                this.instances[key] = { pickr, container };
                pickr.show();
            },
            
            /**
             * Ferme et nettoie un color picker
             * @param {string} key - Cl√© de l'instance √† fermer
             */
            close(key) {
                const instance = this.instances[key];
                if (!instance) return;
                
                try {
                    instance.pickr.destroyAndRemove();
                    instance.container.remove();
                } catch (e) {
                    console.warn('Pickr cleanup error:', e);
                }
                
                delete this.instances[key];
            },
            
            /**
             * Ferme toutes les instances de color pickers
             */
            closeAll() {
                Object.keys(this.instances).forEach(key => this.close(key));
            }
        };
        
        // ============================================
        // MODULE 3: EXPORT MANAGER
        // ============================================
        
        /**
         * Gestionnaire d'export et d'import des projets
         * G√®re les formats HTML et JSON avec versioning
         * @namespace ExportManager
         */
        const ExportManager = {
            /** @constant {string} */
            version: '4.0',
            
            /**
             * Pr√©pare les donn√©es pour l'export
             * @param {Object} project - Donn√©es du projet
             * @returns {Object} Donn√©es enrichies avec m√©tadonn√©es
             */
            prepareForExport(project) {
                return {
                    _version: this.version,
                    _generated: new Date().toISOString(),
                    _generator: 'G√©n√©rateur Cyberattaque v4.0',
                    ...project
                };
            },
            
            /**
             * Exporte le projet en HTML avec donn√©es embarqu√©es
             * @param {Object} project - Donn√©es du projet
             * @param {HTMLElement} previewElement - √âl√©ment DOM √† exporter
             * @returns {string} HTML complet
             */
            exportHTML(project, previewElement) {
                const data = this.prepareForExport(project);
                const customStyles = this.generateCustomStyles(project);
                
                return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="generator" content="G√©n√©rateur Cyberattaque v4.0">
    <meta name="project-version" content="${this.version}">
    <title>${project.content.title}</title>
    <style>
        ${this.getBaseStyles(project)}
        ${customStyles}
    </style>
</head>
<body>
    ${previewElement.outerHTML}
    <script id="project-data" type="application/json">
${JSON.stringify(data, null, 2)}
    <\/script>
</body>
</html>`;
            },
            
            /**
             * G√©n√®re les styles CSS pour les couleurs personnalis√©es
             * @param {Object} project - Donn√©es du projet
             * @returns {string} CSS g√©n√©r√©
             */
            generateCustomStyles(project) {
                let css = '';
                
                project.elements.steps.forEach((step, idx) => {
                    const selector = `.preview-step:nth-child(${idx + 1})`;
                    const context = { project };
                    
                    css += `
        ${selector} {
            border-left-color: ${ColorManager.getColor(step, 'border', context)} !important;
            background: ${ColorManager.getColor(step, 'background', context)} !important;
            color: ${ColorManager.getColor(step, 'text', context)} !important;
        }
        ${selector} h3 {
            color: ${ColorManager.getColor(step, 'text', context)} !important;
        }`;
                    
                    step.actions.forEach((action, aIdx) => {
                        const aSel = `${selector} .preview-action-item:nth-child(${aIdx + 1})`;
                        const actContext = { project, parentStep: step };
                        
                        css += `
        ${aSel} {
            border-left-color: ${ColorManager.getColor(action, 'border', actContext)} !important;
            background: ${ColorManager.getColor(action, 'background', actContext)} !important;
            color: ${ColorManager.getColor(action, 'text', actContext)} !important;
        }`;
                    });
                });
                
                return css;
            },
            
            /**
             * Retourne les styles CSS de base
             * @param {Object} project - Donn√©es du projet
             * @returns {string} CSS de base
             */
            getBaseStyles(project) {
                return `
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: ${project.theme.colors.background}; padding: 20px; }
        .preview-container { max-width: 1200px; margin: 0 auto; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); overflow: hidden; background: ${project.theme.colors.contentBg}; }
        .preview-header { background: linear-gradient(135deg, ${project.theme.colors.header}, ${ColorManager.adjustBrightness(project.theme.colors.header, -20)}); color: white; text-align: center; padding: 50px 30px; position: relative; }
        .preview-header::before { content: '‚ö†Ô∏è'; font-size: 80px; display: block; margin-bottom: 25px; }
        .preview-header.hide-icon::before { display: none; }
        .preview-header h1 { font-size: 3em; font-weight: 900; margin-bottom: 15px; }
        .preview-timeline { display: flex; align-items: center; justify-content: center; margin: 30px 0; flex-wrap: wrap; padding: 0 20px; }
        .preview-timeline-item { color: white; padding: 12px 25px; border-radius: 30px; margin: 8px; font-weight: 700; }
        .preview-steps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 35px; padding: 50px; }
        .preview-step { background: white; border-radius: 20px; padding: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-left: 8px solid; position: relative; }
        .preview-step-icon { font-size: 4em; margin-bottom: 25px; display: block; }
        .preview-step-number { position: absolute; top: -20px; left: 25px; background: linear-gradient(135deg, ${project.theme.colors.stepNumber}, ${ColorManager.adjustBrightness(project.theme.colors.stepNumber, -20)}); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.4em; box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .preview-step h3 { font-size: 1.6em; margin-bottom: 20px; font-weight: 800; }
        .preview-action-item { padding: 18px; border-radius: 12px; margin: 15px 0; border-left: 5px solid; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .preview-emergency-contact { background: linear-gradient(135deg, ${project.theme.colors.emergency}, ${ColorManager.adjustBrightness(project.theme.colors.emergency, -20)}); color: white; padding: 30px; text-align: center; font-size: 1.2em; font-weight: 700; margin: 30px 50px; border-radius: 15px; }
        .preview-footer { background: linear-gradient(135deg, ${project.theme.colors.footer}, ${ColorManager.adjustBrightness(project.theme.colors.footer, -15)}); color: white; text-align: center; padding: 40px 30px; }
        .logo { position: absolute; max-height: 100px; z-index: 10; }
        .logo.top-left { left: 25px; top: 25px; }
        .logo.top-right { right: 25px; top: 25px; }
        .logo.top-center { left: 50%; top: 25px; transform: translateX(-50%); }
        .logo.bottom-left { left: 25px; bottom: 25px; }
        .logo.bottom-right { right: 25px; bottom: 25px; }
        .logo.bottom-center { left: 50%; bottom: 25px; transform: translateX(-50%); }
        `;
            },
            
            /**
             * Importe un projet depuis HTML ou JSON
             * @param {string} fileContent - Contenu du fichier
             * @param {string} fileName - Nom du fichier
             * @returns {Object} Donn√©es du projet
             * @throws {Error} Si le format est invalide
             */
            importProject(fileContent, fileName) {
                let data;
                
                if (fileName.endsWith('.json')) {
                    data = JSON.parse(fileContent);
                } else if (fileName.endsWith('.html')) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(fileContent, 'text/html');
                    const script = doc.getElementById('project-data');
                    
                    if (!script) {
                        throw new Error('Fichier HTML invalide : donn√©es projet introuvables');
                    }
                    
                    data = JSON.parse(script.textContent);
                } else {
                    throw new Error('Format de fichier non support√©');
                }
                
                // Validation basique
                if (!data.metadata || !data.content || !data.theme || !data.elements) {
                    throw new Error('Structure de donn√©es invalide');
                }
                
                return data;
            }
        };
        
        // ============================================
        // MODULE 4: DRAG & DROP MANAGER
        // ============================================
        
        /**
         * Gestionnaire du drag & drop avec SortableJS
         * @namespace DragDropManager
         */
        const DragDropManager = {
            /** @type {Object.<string, Sortable>} */
            instances: {},
            
            /**
             * Initialise le drag & drop pour les √©tapes
             * @param {HTMLElement} container - Conteneur des √©tapes
             * @param {Function} onReorder - Callback de r√©ordonnancement
             * @returns {Sortable} Instance Sortable
             */
            initSteps(container, onReorder) {
                const instance = new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => onReorder(evt.oldIndex, evt.newIndex)
                });
                
                this.instances['steps'] = instance;
                return instance;
            },
            
            /**
             * D√©truit une instance de drag & drop
             * @param {string} key - Cl√© de l'instance
             */
            destroy(key) {
                if (this.instances[key]) {
                    this.instances[key].destroy();
                    delete this.instances[key];
                }
            },
            
            /**
             * D√©truit toutes les instances
             */
            destroyAll() {
                Object.keys(this.instances).forEach(key => this.destroy(key));
            }
        };
        
        // ============================================
        // ALPINE.JS APP - Interface utilisateur
        // ============================================
        
        /**
         * Application Alpine.js principale
         * G√®re l'√©tat et les interactions utilisateur
         * @returns {Object} √âtat et m√©thodes Alpine
         */
        function infographicApp() {
            return {
                // ============================================
                // TEXT FORMATTING TOOLBAR
                // ============================================
                
                /**
                 * Affiche la toolbar au focus du textarea
                 * @param {Event} event - √âv√©nement focus
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 */
                showToolbar(event, stepIndex, actionIndex) {
                    const toolbar = document.getElementById(`toolbar-${stepIndex}-${actionIndex}`);
                    if (toolbar) {
                        toolbar.classList.add('active');
                    }
                },
                
                /**
                 * Masque la toolbar au blur du textarea (avec d√©lai)
                 * @param {Event} event - √âv√©nement blur
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 */
                hideToolbar(event, stepIndex, actionIndex) {
                    // D√©lai pour permettre le clic sur les boutons
                    setTimeout(() => {
                        const toolbar = document.getElementById(`toolbar-${stepIndex}-${actionIndex}`);
                        if (toolbar && !toolbar.matches(':hover')) {
                            toolbar.classList.remove('active');
                        }
                    }, 200);
                },
                
                /**
                 * Ins√®re une balise HTML au curseur
                 * @param {Event} event - √âv√©nement click
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 * @param {string} startTag - Balise ouvrante
                 * @param {string} endTag - Balise fermante
                 */
                insertTag(event, stepIndex, actionIndex, startTag, endTag) {
                    event.preventDefault();
                    const textarea = document.getElementById(`action-textarea-${stepIndex}-${actionIndex}`);
                    if (!textarea) return;
                    
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const selectedText = textarea.value.substring(start, end);
                    const beforeText = textarea.value.substring(0, start);
                    const afterText = textarea.value.substring(end);
                    
                    // Ins√©rer les balises
                    const newText = beforeText + startTag + selectedText + endTag + afterText;
                    
                    // Mettre √† jour le mod√®le Alpine
                    this.project.elements.steps[stepIndex].actions[actionIndex].text = newText;
                    
                    // Remettre le focus et positionner le curseur
                    this.$nextTick(() => {
                        textarea.focus();
                        const newCursorPos = start + startTag.length + selectedText.length + endTag.length;
                        textarea.setSelectionRange(newCursorPos, newCursorPos);
                    });
                },
                
                /**
                 * Ins√®re un surlignage color√©
                 * @param {Event} event - √âv√©nement click
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 */
                insertHighlight(event, stepIndex, actionIndex) {
                    event.preventDefault();
                    const textarea = document.getElementById(`action-textarea-${stepIndex}-${actionIndex}`);
                    if (!textarea) return;
                    
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const selectedText = textarea.value.substring(start, end);
                    
                    if (!selectedText) {
                        this.showError('S√©lectionnez du texte √† surligner');
                        return;
                    }
                    
                    const beforeText = textarea.value.substring(0, start);
                    const afterText = textarea.value.substring(end);
                    
                    // Demander la couleur
                    const color = prompt('Couleur de surlignage (yellow, lime, cyan, pink) :', 'yellow');
                    if (!color) return;
                    
                    const newText = beforeText + `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 3px;">` + selectedText + '</span>' + afterText;
                    
                    this.project.elements.steps[stepIndex].actions[actionIndex].text = newText;
                    
                    this.$nextTick(() => {
                        textarea.focus();
                    });
                },
                
                /**
                 * Ouvre le s√©lecteur d'emoji pour une action
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 */
                openEmojiForAction(stepIndex, actionIndex) {
                    this.emojiSelectorTarget = 'action';
                    this.emojiSelectorIndex = stepIndex;
                    this.emojiSelectorActionIndex = actionIndex;
                    this.showEmojiSelector = true;
                },
                
                // ============================================
                // DONN√âES (Structure v4.0)
                // ============================================
                
                project: {
                    _version: '4.0',
                    
                    metadata: {
                        name: 'Mon infographie cyberattaque',
                        author: '',
                        organization: '',
                        license: 'AGPL-3.0 / Commercial'
                    },
                    
                    content: {
                        title: 'CYBERATTAQUE D√âTECT√âE',
                        subtitle: 'Proc√©dure d\'urgence - Actions imm√©diates √† entreprendre',
                        showHeaderIcon: true,
                        emergencyMessage: 'üö® EN CAS D\'URGENCE : Contactez imm√©diatement votre RSSI ou √©quipe cybers√©curit√© üö®',
                        footerMessage: 'RAPPEL IMPORTANT : Chaque minute compte en cas de cyberattaque\nCette proc√©dure doit √™tre affich√©e et connue de tous les collaborateurs'
                    },
                    
                    theme: {
                        colors: {
                            header: '#dc3545',
                            timeline: '#3498db',
                            stepNumber: '#0056b3',
                            footer: '#2c3e50',
                            emergency: '#ff6b6b',
                            background: '#f8f9fa',
                            contentBg: '#ffffff'
                        }
                    },
                    
                    elements: {
                        logos: [],
                        
                        timeline: [
                            { id: 1, text: 'IMM√âDIAT', type: 'item' },
                            { id: 2, text: '‚Üí', type: 'separator' },
                            { id: 3, text: 'ALERTE', type: 'item' },
                            { id: 4, text: '‚Üí', type: 'separator' },
                            { id: 5, text: 'COMMUNICATION', type: 'item' },
                            { id: 6, text: '‚Üí', type: 'separator' },
                            { id: 7, text: 'CONTINUIT√â', type: 'item' }
                        ],
                        
                        steps: [
                            {
                                id: 1, 
                                number: 1, 
                                icon: 'üñ•Ô∏è', 
                                title: 'ACTIONS IMM√âDIATES', 
                                category: 'immediate',
                                customColors: {
                                    border: null,
                                    background: null,
                                    text: null,
                                    actionBg: null
                                },
                                actions: [
                                    { id: 1, type: 'critical', text: '<strong>NE PAS √âTEINDRE</strong> votre ordinateur/serveur', customColors: null },
                                    { id: 2, type: 'critical', text: '<strong>D√âCONNECTER IMM√âDIATEMENT</strong> du r√©seau :<br>‚Ä¢ D√©brancher le c√¢ble Ethernet<br>‚Ä¢ D√©sactiver le WiFi', customColors: null },
                                    { id: 3, type: 'important', text: 'Isoler physiquement le poste compromis', customColors: null },
                                    { id: 4, type: 'important', text: 'Noter l\'heure exacte et les sympt√¥mes observ√©s', customColors: null }
                                ]
                            },
                            {
                                id: 2, 
                                number: 2, 
                                icon: 'üë•', 
                                title: 'ALERTE HI√âRARCHIQUE', 
                                category: 'management',
                                customColors: { border: null, background: null, text: null, actionBg: null },
                                actions: [
                                    { id: 5, type: 'important', text: '<strong>Responsable de service :</strong><br>Pr√©venir imm√©diatement tous vos agents', customColors: null },
                                    { id: 6, type: 'important', text: 'Remonter l\'information √† la direction g√©n√©rale', customColors: null },
                                    { id: 7, type: 'important', text: 'Contacter l\'√©quipe IT/cybers√©curit√©', customColors: null },
                                    { id: 8, type: 'info', text: 'Activer la cellule de crise si elle existe', customColors: null }
                                ]
                            },
                            {
                                id: 3, 
                                number: 3, 
                                icon: 'üì¢', 
                                title: 'MA√éTRISE COMMUNICATION', 
                                category: 'communication',
                                customColors: { border: null, background: null, text: null, actionBg: null },
                                actions: [
                                    { id: 9, type: 'critical', text: '<strong>INTERDICTION ABSOLUE</strong> de communiquer sans aval de la direction', customColors: null },
                                    { id: 10, type: 'important', text: 'Pas de d√©claration publique, r√©seaux sociaux, presse', customColors: null },
                                    { id: 11, type: 'info', text: 'Centraliser toute communication via un porte-parole d√©sign√©', customColors: null },
                                    { id: 12, type: 'info', text: 'Pr√©parer des √©l√©ments de langage avec la direction', customColors: null }
                                ]
                            },
                            {
                                id: 4, 
                                number: 4, 
                                icon: 'üìã', 
                                title: 'PLAN DE CONTINUIT√â', 
                                category: 'continuity',
                                customColors: { border: null, background: null, text: null, actionBg: null },
                                actions: [
                                    { id: 13, type: 'success', text: '<strong>Activer les fiches r√©flexes</strong> du Plan de Continuit√© M√©tier (PCM)', customColors: null },
                                    { id: 14, type: 'success', text: 'Identifier les processus critiques √† maintenir', customColors: null },
                                    { id: 15, type: 'success', text: 'Basculer sur les solutions de secours pr√©vues', customColors: null },
                                    { id: 16, type: 'info', text: 'Documenter toutes les actions entreprises', customColors: null }
                                ]
                            }
                        ]
                    }
                },
                
                // ============================================
                // UI STATE
                // ============================================
                
                colorLabels: {
                    header: 'En-t√™te',
                    timeline: 'Timeline',
                    stepNumber: 'Num√©ros',
                    footer: 'Pied de page',
                    emergency: 'Urgence',
                    background: 'Fond',
                    contentBg: 'Contenu'
                },
                
                availableEmojis: [
                    "üñ•Ô∏è", "üíª", "üì±", "‚å®Ô∏è", "üñ±Ô∏è", "üñ®Ô∏è", "üíæ", "üíø", "üìÄ", "üìå",
                    "üõ°Ô∏è", "üîê", "üîì", "üîí", "üîë", "üóùÔ∏è", "üö®", "‚ö†Ô∏è", "‚õî", "üö´",
                    "üìû", "‚òéÔ∏è", "üì≤", "üìß", "üì®", "üì©", "üì§", "üì•", "‚úâÔ∏è", "üì¢",
                    "üë§", "üë•", "üë®‚Äçüíº", "üë©‚Äçüíº", "üë®‚Äçüíª", "üë©‚Äçüíª", "üïµÔ∏è", "üëÆ", "üë∑", "üíÇ",
                    "‚úÖ", "‚úîÔ∏è", "‚òëÔ∏è", "‚éò", "‚ùå", "‚≠ï", "üéØ", "üÉè", "‚è∞", "‚è±Ô∏è",
                    "üìÑ", "üìÉ", "üìë", "üìä", "üìà", "üìâ", "üìã", "üîñ", "üìç", "üìé",
                    "üÜò", "üöë", "üöí", "üöì", "üöî", "‚úàÔ∏è", "üöÄ", "‚Üí", "‚áí", "‚û°Ô∏è",
                    "‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚¨ÖÔ∏è", "‚ÜóÔ∏è", "‚ÜòÔ∏è", "‚ÜôÔ∏è", "‚ÜñÔ∏è", "‚ÜîÔ∏è", "‚ÜïÔ∏è", "üîÑ"
                ],
                
                showExportModal: false,
                showEmojiSelector: false,
                emojiSelectorTarget: null,
                emojiSelectorIndex: null,
                emojiSelectorActionIndex: null, // Pour les actions
                
                // Options export PDF
                pdfFormat: 'A3',
                pdfOrientation: 'portrait',
                
                notyf: null,
                isInitialized: false,
                currentNotification: null,
                
                // ============================================
                // INITIALISATION
                // ============================================
                
                /**
                 * Initialise l'application
                 */
                async init() {
                    // √âviter la double initialisation
                    if (this.isInitialized) {
                        console.warn('Alpine d√©j√† initialis√©, skip');
                        return;
                    }
                    this.isInitialized = true;
                    
                    // Charger projet depuis localStorage
                    await this.loadProject();
                    
                    // Initialiser Sortable pour les steps
                    this.$nextTick(() => {
                        DragDropManager.initSteps(
                            this.$refs.stepsContainer,
                            (oldIdx, newIdx) => this.reorderSteps(oldIdx, newIdx)
                        );
                    });
                    
                    // Auto-save sur changements
                    this.$watch('project', () => this.autoSave(), { deep: true });
                    
                    this.showSuccess('‚ú® G√©n√©rateur v4.0 pr√™t !');
                },
                
                // ============================================
                // GESTION DES COULEURS (Interface vers ColorManager)
                // ============================================
                
                /**
                 * Obtient la couleur d'une √©tape
                 * @param {Object} step - L'√©tape
                 * @param {string} type - Type de couleur
                 * @returns {string} Couleur
                 */
                getStepColor(step, type) {
                    return ColorManager.getColor(step, type, { project: this.project });
                },
                
                /**
                 * Obtient la couleur d'une action
                 * @param {Object} action - L'action
                 * @param {Object} step - L'√©tape parente
                 * @param {string} type - Type de couleur
                 * @returns {string} Couleur
                 */
                getActionColor(action, step, type) {
                    return ColorManager.getColor(action, type, { 
                        project: this.project, 
                        parentStep: step 
                    });
                },
                
                /**
                 * Ouvre le color picker pour une couleur globale
                 * @param {string} colorKey - Cl√© de la couleur
                 */
                openGlobalColorPicker(colorKey) {
                    PickrManager.open(
                        `global-${colorKey}`,
                        this.project.theme.colors[colorKey],
                        (newColor) => {
                            this.project.theme.colors[colorKey] = newColor;
                            this.showSuccess(`Couleur ${this.colorLabels[colorKey]} modifi√©e`);
                        }
                    );
                },
                
                /**
                 * Ouvre le color picker pour une √©tape
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {string} colorType - Type de couleur
                 */
                openStepColorPicker(stepIndex, colorType) {
                    const step = this.project.elements.steps[stepIndex];
                    const currentColor = this.getStepColor(step, colorType);
                    
                    PickrManager.open(
                        `step-${stepIndex}-${colorType}`,
                        currentColor,
                        (newColor) => {
                            // Initialiser customColors si besoin
                            if (!step.customColors) {
                                step.customColors = { border: null, background: null, text: null, actionBg: null };
                            }
                            
                            // Appliquer la nouvelle couleur
                            step.customColors[colorType] = newColor;
                            
                            // Forcer la r√©activit√© Alpine avec r√©assignation compl√®te
                            const updatedSteps = [...this.project.elements.steps];
                            updatedSteps[stepIndex] = { ...step };
                            this.project.elements.steps = updatedSteps;
                            
                            const labels = {
                                border: 'bordure',
                                background: 'fond',
                                text: 'texte',
                                actionBg: 'fond des actions'
                            };
                            this.showSuccess(`Couleur ${labels[colorType]} modifi√©e`);
                        },
                        { allowOpacity: colorType === 'actionBg' }
                    );
                },
                
                /**
                 * V√©rifie si l'√©tape a des couleurs personnalis√©es
                 * @param {Object} step - L'√©tape
                 * @returns {boolean}
                 */
                hasCustomStepColors(step) {
                    if (!step.customColors) return false;
                    return Object.values(step.customColors).some(v => v !== null);
                },
                
                /**
                 * R√©initialise les couleurs d'une √©tape
                 * @param {number} stepIndex - Index de l'√©tape
                 */
                resetStepColors(stepIndex) {
                    this.project.elements.steps[stepIndex].customColors = {
                        border: null,
                        background: null,
                        text: null,
                        actionBg: null
                    };
                    this.showSuccess('Couleurs r√©initialis√©es');
                },
                
                /**
                 * Active/d√©sactive la personnalisation des couleurs d'une action
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 */
                toggleActionCustomColors(stepIndex, actionIndex) {
                    const step = this.project.elements.steps[stepIndex];
                    const action = step.actions[actionIndex];
                    
                    if (action.customColors) {
                        // D√©sactiver la personnalisation
                        action.customColors = null;
                        
                        // Forcer la r√©activit√© Alpine
                        const updatedActions = [...step.actions];
                        updatedActions[actionIndex] = { ...action };
                        const updatedSteps = [...this.project.elements.steps];
                        updatedSteps[stepIndex] = { ...step, actions: updatedActions };
                        this.project.elements.steps = updatedSteps;
                        
                        this.showSuccess('‚ú® Personnalisation d√©sactiv√©e - couleurs par d√©faut appliqu√©es');
                    } else {
                        // Activer la personnalisation
                        action.customColors = {
                            border: null,
                            background: null,
                            text: null
                        };
                        
                        // Forcer la r√©activit√© Alpine
                        const updatedActions = [...step.actions];
                        updatedActions[actionIndex] = { ...action };
                        const updatedSteps = [...this.project.elements.steps];
                        updatedSteps[stepIndex] = { ...step, actions: updatedActions };
                        this.project.elements.steps = updatedSteps;
                        
                        this.showSuccess('üé® Personnalisation activ√©e - cliquez sur les couleurs');
                    }
                },
                
                /**
                 * Ouvre le color picker pour une action
                 * @param {number} stepIndex - Index de l'√©tape
                 * @param {number} actionIndex - Index de l'action
                 * @param {string} colorType - Type de couleur
                 */
                openActionColorPicker(stepIndex, actionIndex, colorType) {
                    const action = this.project.elements.steps[stepIndex].actions[actionIndex];
                    const step = this.project.elements.steps[stepIndex];
                    const currentColor = this.getActionColor(action, step, colorType);
                    
                    PickrManager.open(
                        `action-${stepIndex}-${actionIndex}-${colorType}`,
                        currentColor,
                        (newColor) => {
                            // Initialiser customColors si besoin
                            if (!action.customColors) {
                                action.customColors = { border: null, background: null, text: null };
                            }
                            
                            // Appliquer la nouvelle couleur
                            action.customColors[colorType] = newColor;
                            
                            // Forcer la r√©activit√© Alpine avec r√©assignation compl√®te
                            const updatedActions = [...step.actions];
                            updatedActions[actionIndex] = { ...action };
                            const updatedSteps = [...this.project.elements.steps];
                            updatedSteps[stepIndex] = { ...step, actions: updatedActions };
                            this.project.elements.steps = updatedSteps;
                            
                            const labels = {
                                border: 'bordure',
                                background: 'fond',
                                text: 'texte'
                            };
                            this.showSuccess(`Action : couleur ${labels[colorType]} modifi√©e`);
                        },
                        { allowOpacity: colorType === 'background' }
                    );
                },
                
                // ============================================
                // GESTION DES LOGOS
                // ============================================
                
                /**
                 * Ajoute un nouveau logo
                 */
                addLogo() {
                    const newId = Math.max(...(this.project.elements.logos.map(l => l.id) || [0]), 0) + 1;
                    this.project.elements.logos.push({
                        id: newId,
                        url: '',
                        file: '',
                        position: 'top-left',
                        size: 120
                    });
                    this.showSuccess('Logo ajout√©');
                },
                
                /**
                 * Supprime un logo
                 * @param {number} index - Index du logo
                 */
                removeLogo(index) {
                    this.project.elements.logos.splice(index, 1);
                    this.showSuccess('Logo supprim√©');
                },
                
                /**
                 * G√®re le t√©l√©chargement d'un fichier logo
                 * @param {Event} event - √âv√©nement du fichier
                 * @param {number} logoIndex - Index du logo
                 */
                handleLogoFile(event, logoIndex) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        this.showError('Veuillez s√©lectionner une image');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        this.showError('Fichier trop volumineux (max 5MB)');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.project.elements.logos[logoIndex].file = e.target.result;
                        this.project.elements.logos[logoIndex].url = '';
                        this.showSuccess('Logo charg√©');
                    };
                    reader.readAsDataURL(file);
                },
                
                /**
                 * Met √† jour le logo depuis une URL
                 * @param {number} logoIndex - Index du logo
                 */
                updateLogoFromUrl(logoIndex) {
                    if (this.project.elements.logos[logoIndex].url) {
                        this.project.elements.logos[logoIndex].file = '';
                        this.showSuccess('Logo charg√© depuis URL');
                    }
                },
                
                // ============================================
                // GESTION TIMELINE
                // ============================================
                
                /**
                 * Ajoute un √©l√©ment √† la timeline
                 */
                addTimelineItem() {
                    const newId = Math.max(...this.project.elements.timeline.map(t => t.id), 0) + 1;
                    this.project.elements.timeline.push({
                        id: newId,
                        text: 'NOUVELLE √âTAPE',
                        type: 'item'
                    });
                    this.showSuccess('√âl√©ment ajout√©');
                },
                
                // ============================================
                // GESTION STEPS
                // ============================================
                
                /**
                 * Ajoute une nouvelle √©tape
                 */
                addStep() {
                    const newId = Math.max(...this.project.elements.steps.map(s => s.id), 0) + 1;
                    const newNumber = Math.max(...this.project.elements.steps.map(s => s.number), 0) + 1;
                    
                    this.project.elements.steps.push({
                        id: newId,
                        number: newNumber,
                        icon: '‚ùì',
                        title: 'NOUVELLE √âTAPE',
                        category: 'info',
                        customColors: {
                            border: null,
                            background: null,
                            text: null,
                            actionBg: null
                        },
                        actions: [
                            { id: Date.now(), type: 'info', text: 'Nouvelle action', customColors: null }
                        ]
                    });
                    
                    this.showSuccess('√âtape ajout√©e');
                },
                
                /**
                 * Duplique une √©tape
                 * @param {number} stepIndex - Index de l'√©tape
                 */
                duplicateStep(stepIndex) {
                    const original = this.project.elements.steps[stepIndex];
                    const newId = Math.max(...this.project.elements.steps.map(s => s.id), 0) + 1;
                    const newStep = JSON.parse(JSON.stringify(original));
                    
                    newStep.id = newId;
                    newStep.number = Math.max(...this.project.elements.steps.map(s => s.number), 0) + 1;
                    newStep.title += ' (Copie)';
                    
                    this.project.elements.steps.splice(stepIndex + 1, 0, newStep);
                    this.showSuccess('√âtape dupliqu√©e');
                },
                
                /**
                 * Supprime une √©tape
                 * @param {number} stepIndex - Index de l'√©tape
                 */
                removeStep(stepIndex) {
                    if (this.project.elements.steps.length <= 1) {
                        this.showError('Impossible de supprimer la derni√®re √©tape');
                        return;
                    }
                    this.project.elements.steps.splice(stepIndex, 1);
                    this.showSuccess('√âtape supprim√©e');
                },
                
                /**
                 * R√©ordonne les √©tapes (drag & drop)
                 * @param {number} oldIndex - Ancien index
                 * @param {number} newIndex - Nouvel index
                 */
                reorderSteps(oldIndex, newIndex) {
                    const item = this.project.elements.steps.splice(oldIndex, 1)[0];
                    this.project.elements.steps.splice(newIndex, 0, item);
                    this.showSuccess('Ordre modifi√©');
                },
                
                // ============================================
                // GESTION ACTIONS
                // ============================================
                
                /**
                 * Ajoute une action √† une √©tape
                 * @param {number} stepIndex - Index de l'√©tape
                 */
                addAction(stepIndex) {
                    this.project.elements.steps[stepIndex].actions.push({
                        id: Date.now(),
                        type: 'info',
                        text: 'Nouvelle action',
                        customColors: null
                    });
                    this.showSuccess('Action ajout√©e');
                },
                
                // ============================================
                // EMOJI SELECTOR
                // ============================================
                
                /**
                 * Ouvre le s√©lecteur d'emojis
                 * @param {string} target - Cible ('timeline' ou 'step')
                 * @param {number} index - Index de l'√©l√©ment
                 */
                openEmojiSelector(target, index) {
                    this.emojiSelectorTarget = target;
                    this.emojiSelectorIndex = index;
                    this.showEmojiSelector = true;
                },
                
                /**
                 * Ferme le s√©lecteur d'emojis
                 */
                closeEmojiSelector() {
                    this.showEmojiSelector = false;
                    this.emojiSelectorTarget = null;
                    this.emojiSelectorIndex = null;
                    this.emojiSelectorActionIndex = null;
                },
                
                /**
                 * S√©lectionne un emoji
                 * @param {string} emoji - Emoji s√©lectionn√©
                 */
                selectEmoji(emoji) {
                    if (this.emojiSelectorTarget === 'timeline') {
                        this.project.elements.timeline[this.emojiSelectorIndex].text = emoji;
                    } else if (this.emojiSelectorTarget === 'step') {
                        this.project.elements.steps[this.emojiSelectorIndex].icon = emoji;
                    } else if (this.emojiSelectorTarget === 'action') {
                        // Ins√©rer l'emoji dans le textarea de l'action
                        const stepIndex = this.emojiSelectorIndex;
                        const actionIndex = this.emojiSelectorActionIndex;
                        const textarea = document.getElementById(`action-textarea-${stepIndex}-${actionIndex}`);
                        
                        if (textarea) {
                            const start = textarea.selectionStart || 0;
                            const end = textarea.selectionEnd || 0;
                            const currentText = this.project.elements.steps[stepIndex].actions[actionIndex].text;
                            const beforeText = currentText.substring(0, start);
                            const afterText = currentText.substring(end);
                            
                            this.project.elements.steps[stepIndex].actions[actionIndex].text = beforeText + emoji + afterText;
                            
                            this.$nextTick(() => {
                                textarea.focus();
                                const newPos = start + emoji.length;
                                textarea.setSelectionRange(newPos, newPos);
                            });
                        }
                    }
                    this.closeEmojiSelector();
                    this.showSuccess(`Emoji ${emoji} ${this.emojiSelectorTarget === 'action' ? 'ins√©r√©' : 's√©lectionn√©'}`);
                },
                
                // ============================================
                // EXPORT / IMPORT
                // ============================================
                
                /**
                 * Exporte en HTML
                 */
                exportHTML() {
                    const preview = document.getElementById('preview-container');
                    const html = ExportManager.exportHTML(this.project, preview);
                    
                    this.downloadFile(
                        html, 
                        'text/html', 
                        `${this.project.metadata.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.html`
                    );
                    
                    this.showExportModal = false;
                    this.showSuccess('HTML export√©');
                },
                
                /**
                 * Exporte en PDF avec gestion des formats A3/A2
                 */
                async exportPDF() {
                    // V√©rifier le nombre d'√©tapes
                    if (this.project.elements.steps.length > 10) {
                        if (!confirm('‚ö†Ô∏è Votre infographie contient ' + this.project.elements.steps.length + ' √©tapes. Le rendu sur poster risque d\'√™tre difficile √† lire. Continuer quand m√™me ?')) {
                            return;
                        }
                    }
                    
                    // Notification courte (ne pas attendre qu'elle se ferme)
                    this.showSuccess('‚è≥ G√©n√©ration PDF en cours...');
                    
                    // Petit d√©lai pour laisser la notification s'afficher
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    try {
                        const preview = document.getElementById('preview-container');
                        
                        // Dimensions en mm pour 300 DPI (11.811 px/mm)
                        const formats = {
                            A3: { portrait: { w: 297, h: 420 }, landscape: { w: 420, h: 297 } },
                            A2: { portrait: { w: 420, h: 594 }, landscape: { w: 594, h: 420 } }
                        };
                        
                        const selectedFormat = formats[this.pdfFormat][this.pdfOrientation];
                        const pxPerMm = 11.811; // 300 DPI
                        
                        // Dimensions cibles en pixels pour 300 DPI
                        const targetWidth = selectedFormat.w * pxPerMm;
                        const targetHeight = selectedFormat.h * pxPerMm;
                        
                        // Calculer le scale n√©cessaire bas√© sur la largeur du preview
                        const previewWidth = preview.offsetWidth;
                        const scale = targetWidth / previewWidth;
                        
                        // G√©n√©rer canvas haute r√©solution
                        const canvas = await html2canvas(preview, {
                            scale: scale,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: this.project.theme.colors.background,
                            width: previewWidth,
                            height: preview.scrollHeight,
                            logging: false,
                            removeContainer: true
                        });
                        
                        // Cr√©er PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: this.pdfOrientation,
                            unit: 'mm',
                            format: this.pdfFormat.toLowerCase()
                        });
                        
                        // Dimensions de la page PDF
                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        
                        // Convertir canvas en image
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        
                        // Calculer dimensions pour fit sur 1 page avec marges
                        const margin = 10; // 10mm de marge
                        const availableWidth = pageWidth - (margin * 2);
                        const availableHeight = pageHeight - (margin * 2);
                        
                        // Ratio de l'image
                        const imgRatio = canvas.height / canvas.width;
                        
                        // Calculer dimensions finales en respectant le ratio
                        let finalWidth = availableWidth;
                        let finalHeight = availableWidth * imgRatio;
                        
                        // Si trop haut, ajuster par la hauteur
                        if (finalHeight > availableHeight) {
                            finalHeight = availableHeight;
                            finalWidth = finalHeight / imgRatio;
                        }
                        
                        // Centrer sur la page
                        const x = (pageWidth - finalWidth) / 2;
                        const y = (pageHeight - finalHeight) / 2;
                        
                        // Ajouter l'image au PDF
                        pdf.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight);
                        
                        // Sauvegarder
                        const filename = `${this.project.metadata.name.replace(/[^a-zA-Z0-9]/g, '_')}_${this.pdfFormat}_${this.pdfOrientation}_${new Date().toISOString().split('T')[0]}.pdf`;
                        pdf.save(filename);
                        
                        this.showExportModal = false;
                        
                        // Petit d√©lai avant la notification de succ√®s pour √©viter la collision
                        await new Promise(resolve => setTimeout(resolve, 200));
                        this.showSuccess('‚úÖ PDF g√©n√©r√© avec succ√®s !');
                        
                    } catch (error) {
                        console.error('Erreur PDF:', error);
                        this.showError('‚ùå Erreur lors de la g√©n√©ration du PDF');
                    }
                },
                
                /**
                 * Exporte en PNG
                 */
                async exportPNG() {
                    // Notification courte
                    this.showSuccess('‚è≥ G√©n√©ration PNG en cours...');
                    
                    // Petit d√©lai pour laisser la notification s'afficher
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    try {
                        const preview = document.getElementById('preview-container');
                        
                        const canvas = await html2canvas(preview, {
                            scale: 4,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            logging: false,
                            removeContainer: true
                        });
                        
                        canvas.toBlob(blob => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            const filename = `${this.project.metadata.name.replace(/[^a-zA-Z0-9]/g, '_')}_300dpi_${new Date().toISOString().split('T')[0]}.png`;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                            
                            this.showExportModal = false;
                            
                            // Petit d√©lai avant la notification de succ√®s
                            setTimeout(() => {
                                this.showSuccess('‚úÖ PNG g√©n√©r√© avec succ√®s !');
                            }, 200);
                        }, 'image/png', 1.0);
                        
                    } catch (error) {
                        console.error('Erreur PNG:', error);
                        this.showError('‚ùå Erreur lors de la g√©n√©ration du PNG');
                    }
                },
                
                /**
                 * G√®re le chargement d'un fichier projet
                 * @param {Event} event - √âv√©nement du fichier
                 */
                handleLoadFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    if (!file.name.endsWith('.html') && !file.name.endsWith('.json')) {
                        this.showError('Veuillez s√©lectionner un fichier HTML ou JSON');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.project = ExportManager.importProject(
                                e.target.result,
                                file.name
                            );
                            
                            // R√©initialiser Sortable apr√®s chargement
                            this.$nextTick(() => {
                                DragDropManager.destroy('steps');
                                DragDropManager.initSteps(
                                    this.$refs.stepsContainer,
                                    (oldIdx, newIdx) => this.reorderSteps(oldIdx, newIdx)
                                );
                            });
                            
                            this.showSuccess(`Projet "${this.project.metadata.name}" charg√©`);
                        } catch (error) {
                            this.showError('Erreur lors du chargement');
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                    
                    // Reset input
                    event.target.value = '';
                },
                
                /**
                 * Sauvegarde le projet en JSON
                 */
                saveProject() {
                    const data = ExportManager.prepareForExport(this.project);
                    this.downloadFile(
                        JSON.stringify(data, null, 2),
                        'application/json',
                        `${this.project.metadata.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.json`
                    );
                    this.showSuccess('Projet sauvegard√©');
                },
                
                /**
                 * R√©initialise le projet
                 */
                async resetProject() {
                    if (confirm('Tout r√©initialiser ? Cette action est irr√©versible.')) {
                        localStorage.removeItem('infographic_v4');
                        location.reload();
                    }
                },
                
                // ============================================
                // STORAGE (localStorage)
                // ============================================
                
                /**
                 * Sauvegarde automatique dans localStorage
                 */
                autoSave() {
                    try {
                        localStorage.setItem('infographic_v4', JSON.stringify(this.project));
                    } catch (error) {
                        console.warn('Auto-save error:', error);
                    }
                },
                
                /**
                 * Charge le projet depuis localStorage
                 */
                async loadProject() {
                    try {
                        const saved = localStorage.getItem('infographic_v4');
                        if (saved) {
                            this.project = JSON.parse(saved);
                            console.log('Projet restaur√© depuis localStorage');
                        }
                    } catch (error) {
                        console.warn('Load error:', error);
                    }
                },
                
                // ============================================
                // UTILITAIRES
                // ============================================
                
                /**
                 * Affiche une notification success de mani√®re contr√¥l√©e
                 * @param {string} message - Message √† afficher
                 */
                showSuccess(message) {
                    NotificationManager.success(message);
                },
                
                /**
                 * Affiche une notification error de mani√®re contr√¥l√©e
                 * @param {string} message - Message √† afficher
                 */
                showError(message) {
                    NotificationManager.error(message);
                },
                
                /**
                 * Supprime toutes les notifications affich√©es
                 */
                clearAllNotifications() {
                    NotificationManager.clear();
                },
                
                /**
                 * Ajuste la luminosit√© d'une couleur
                 * @param {string} hex - Couleur hex
                 * @param {number} amount - Montant d'ajustement
                 * @returns {string} Couleur ajust√©e
                 */
                adjustBrightness(hex, amount) {
                    return ColorManager.adjustBrightness(hex, amount);
                },
                
                /**
                 * Formate le texte (remplace \n par <br>)
                 * @param {string} text - Texte √† formater
                 * @returns {string} Texte format√©
                 */
                formatText(text) {
                    return text.replace(/\n/g, '<br>');
                },
                
                /**
                 * T√©l√©charge un fichier
                 * @param {string} content - Contenu du fichier
                 * @param {string} mimeType - Type MIME
                 * @param {string} filename - Nom du fichier
                 */
                downloadFile(content, mimeType, filename) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }
        }
    </script>
</body>
</html>